box:
  id: cosyverif/docker-images:luajit
  cmd: /bin/bash
build:
  steps:
    - script:
        name: "install"
        code: |
          apk add --no-cache --virtual .build-deps \
              build-base \
              make \
              perl \
              openssl-dev
          luarocks install compat52 || true
          luarocks install rockspec/hashids-develop-0.rockspec
          luarocks install rockspec/lua-websockets-develop-0.rockspec
          luarocks make    rockspec/cosy-editor-env-master-1.rockspec
          luarocks make    rockspec/cosy-editor-master-1.rockspec
          apk del .build-deps
    - script:
        name: "check"
        code: |
          luacheck src/
    - script:
        name: "test"
        code: |
          busted src/
    - script:
        name: "upload to luarocks"
        code: |
          if [ "${WERCKER_GIT_BRANCH}" = "master" ]; then
            tag=$(git describe --tags --abbrev=0 || echo "0.0")
            count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
            cd rockspec || exit 1
            sed -e "s/master-1/${tag}-${count}/" \
                -e "s/master/${tag}/" \
              "cosy-editor-master-1.rockspec" \
              > "cosy-editor-${tag}-${count}.rockspec"
            luarocks upload \
              --force \
              --api-key="${LUAROCKS_TOKEN}" \
              "cosy-editor-${tag}-${count}.rockspec"
            cd ..
          fi
  after-steps:
    - slack-notifier:
        url: $SLACK_URL
        channel: notifications
        username: CosyVerif
        branch: ${WERCKER_GIT_BRANCH}
    - script:
        name: "export to coveralls"
        code: |
          luacov-coveralls \
            --repo-token "${COVERALLS_TOKEN}" \
            --exclude share --exclude busted --exclude _spec \
            --include cosy \
            --root src/ \
            --service-name "${WERCKER_GIT_BRANCH}"
